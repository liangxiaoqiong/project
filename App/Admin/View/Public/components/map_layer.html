<!--地图弹框-->
<style>
  #allmap {
    width: 100%;
    height: 300px;
  }
  #allmap img {
    max-width: inherit;
  }
</style>
<script type="x-template" id="map_layer">
  <el-dialog
      title="设置经纬度"
      width="640px"
      :visible.sync="isShowLayer">
    <div class="dialog-scroll">
      <div class="mb-10">
        <span>地址搜索：</span>
        <input type="text" class="input-inner small width-400" v-model="keyword">
        <a class="xxbtn-primary" @click="searchAddressMap">查找地址</a>
      </div>
      <div id="allmap"></div>
      <div class="mt-10">注：拖动红色图标到相应位置然后点击确定<font class="color-gray">(用鼠标滚轮可以缩放地图)</font></div>
    </div>
    <div slot="footer" class="dialog-footer">
      <a class="xxbtn-white" @click="isShowLayer = false">取消</a>
      <a class="xxbtn-primary" @click="getLAVal">确定</a>
    </div>
  </el-dialog>
</script>
<script type="text/javascript" src="//api.map.baidu.com/api?v=2.0&ak=Eg2jEs4qqyrkkGaFcW5z9aa6afUPy655"></script>
<if condition="$member.map_type eq '2'">
  <script type="text/javascript"
          src="//maps.googleapis.com/maps/api/js?key=AIzaSyCr6MqlEExlC80qTW0codLGIUazXVHEpvw&sensor=false"></script>
</if>
<script>
  var marker;
  var initMarker;
  var newMarker;
  AppUtil.COMPONENTS.MAP_LAYER = {
    template: '#map_layer',
    props: {
      pageSource: {
        type: String,
        default: ''
      },
      mapInfo: Object
      //{map_type: 1-百度地图，2-谷歌地图}
    },
    data: function () {
      return {
        isShowLayer: false,
        mapEl: null,
        keyword: ''
      }
    },
    methods: {
      showLayer: function () {
        var self = this;
        self.keyword = '';
        self.isShowLayer = true;
        self.$nextTick(function () {
          self.initMap()
        })
      },
      hideLayer: function () {
        this.isShowLayer = false;
      },
      /*初始化地图 api*/
      initMap: function () {
        var self = this
        self.$nextTick(function () {
          if (+self.mapInfo.map_type === 1) {
            self.mapBaiDu()
          } else {
            self.mapGoogle()
          }
        })
      },
      //获取经纬度
      getLAVal: function () {
        var self = this
        self.$nextTick(function () {
          if (+self.mapInfo.map_type === 1) {
            self.getValBaiDu()
          } else {
            self.getValGoogle()
          }
        })
      },
      /**region 百度地图*/
      mapBaiDu: function () {
        var self = this
        self.mapEl = new BMap.Map("allmap");
        self.mapEl.enableScrollWheelZoom(true);

        if (self.mapInfo.longitude === '' && self.mapInfo.latitude === '') {
          if (self.pageSource === 'pick_store_info' && self.mapInfo.area_id > 0 && self.mapInfo.address !== '') {
            // 自提门店编辑
            var mapAddress = self.mapInfo.country + '' + self.mapInfo.province + '' + self.mapInfo.city + '' + self.mapInfo.area + '' + self.mapInfo.address;
            self.addressToMap(mapAddress);
          } else {
            self.getLocateCurrent();
          }
        } else {
          self.markerBaiDu(self.mapInfo);
        }
      },
      searchAddressMap: function () {
        if (this.keyword === '') {
          publicWap.layerMsg('请输入地址');
          return false;
        }
        this.addressToMap(this.keyword);
      },
      // 根据地址解析地图
      addressToMap: function (mapAddress) {
        var self = this
        var myGeo = new BMap.Geocoder();
        myGeo.getPoint(mapAddress, function(point){
          if(point){
            self.markerBaiDu({longitude: point.lng, latitude: point.lat});
          }else{
            alert('您选择的地址没有解析到结果！');
          }
        }, '北京市')
      },
      //定位用户当前位置
      getLocateCurrent: function () {
        var self = this
        var geolocation = new BMap.Geolocation();
        geolocation.getCurrentPosition(function (r) {
          if (this.getStatus() == BMAP_STATUS_SUCCESS) {
            self.markerBaiDu({longitude: r.point.lng, latitude: r.point.lat});
          } else {
            alert('failed' + this.getStatus());
          }
        }, {enableHighAccuracy: true})
      },
      markerBaiDu: function (pointData) {
        var self = this;
        var new_point = new BMap.Point(pointData.longitude, pointData.latitude);
        self.mapEl.centerAndZoom(new_point, 16);
        newMarker = new BMap.Marker(new_point);   //全局变量
        self.mapEl.addOverlay(newMarker);
        newMarker.enableDragging();
      },
      getValBaiDu: function () {
        var self = this
        var newLng = newMarker.point.lng;
        var newLat = newMarker.point.lat;
        self.mapInfo.longitude = newLng;
        self.mapInfo.latitude = newLat;
        self.hideLayer()
      },
      /**endregion*/

      /**region 谷歌地图*/
      mapGoogle: function () {
        var self = this
        var longitude = 0
        var latitude = 0
        // 谷歌地图API功能
        if ((+self.mapInfo.longitude === 0 || self.mapInfo.longitude === '') && (+self.mapInfo.latitude === 0 || self.mapInfo.latitude === '')) {
          var  url = 'https://www.googleapis.com/geolocation/v1/geolocate?key=AIzaSyCr6MqlEExlC80qTW0codLGIUazXVHEpvw';
          $.ajax({
            type: "POST",
            url: url,
            data: {},
            dataType: "json",
            async: false ,
            success: function(data){
              longitude = data.location.lng;
              latitude = data.location.lat;
            },
            error:function(){
              alert('访问失败');
            }
          });

        }
        var myCenter=new google.maps.LatLng(latitude, longitude);
        // marker;
        var mapProp = {
          center:myCenter,
          zoom:13,
          mapTypeId:google.maps.MapTypeId.ROADMAP
        };
        var map=new google.maps.Map(document.getElementById("allmap"),mapProp);
        marker=new google.maps.Marker({
          position:myCenter,
          draggable: true
        });
        marker.setMap(map);

      },
      getValGoogle: function () {
        var self = this
        var iniLat = marker.position.lat();
        var iniLng = marker.position.lng();
        self.mapInfo.longitude = iniLng;
        self.mapInfo.latitude = iniLat;
        self.hideLayer()
      }
      /**endregion*/
    }
  }
</script>
