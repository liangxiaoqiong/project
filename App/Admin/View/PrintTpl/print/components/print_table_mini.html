<!--
  @author   liangxiaoqiong
  @version  1.0
  @date 2021/7/9
  -->
<!-- template 打印模板编辑器表格、热敏打印表格-->
<script type="x-template" id="print_table_mini">
  <!--region 模版-->
  <table class="editor-order-table">
    <!--region 表头-->
    <thead>
    <tr>
      <td v-for="(table, index) in getCheckedItemList" :style="tableThTdStyle(index)" v-if="tableThTd(table, index).isShow">
        {{ tableThTd(table, index).th_name }}
      </td>
    </tr>
    </thead>
    <!--endregion-->
    <tbody>
    <template v-for="(goods, gIndex) in depot.goodsList" v-if="isShowGoods(pIndex, gIndex)">
      <tr>
        <td v-for="(table, index) in getCheckedItemList" :style="tableThTdStyle(index)" v-if="tableThTd(table, index).isShow">
          {{ tableThTd(table, index, goods).td_name }}
        </td>
      </tr>
      <template>
        <tr v-for="(table, index) in getCheckedItemList" v-if="!tableThTd(table, index).isShow && table.type !== 'goods_price'">
          <td colspan="3" style="text-align: left;">
            {{ table.diy_name !== '' ? table.diy_name : table.default_name }}:
            <!--空白列1、空白列2、空白列3-->
            <template v-if="table.type === 'other_1' || table.type === 'other_2' || table.type === 'other_3'">
              <template v-if="table.value_data">
                <template v-if="+table.value_data.value_type === 1"><!--空白列项--></template>
                <template v-else-if="+table.value_data.value_type === 2">
                  <!--固定列值-->
                  {{ table.value_data.default_value }}
                </template>
                <template v-else>
                  <!--关联其他基础数据值-->
                  {{ goods[table.value_data.value_type] }}
                </template>
              </template>
            </template>
            <template v-else>{{ goods[table.type] }}</template>
          </td>
        </tr>
      </template>

      <!--region 赠品-->
      <template v-if="goods.send_goods && goods.send_goods.length > 0">
        <template v-for="sendGoods in goods.send_goods">
          <tr>
            <td v-for="(table, index) in getCheckedItemList" :style="tableThTdStyle(index)" v-if="tableThTd(table, index).isShow">
              {{ tableThTd(table, index, goods).td_name }}
            </td>
          </tr>
          <template>
        <tr v-for="(table, index) in getCheckedItemList" v-if="!tableThTd(table, index).isShow && table.type !== 'goods_price'">
          <td colspan="3" style="text-align: left;">
            {{ table.diy_name !== '' ? table.diy_name : table.default_name }}:
            <!--空白列1、空白列2、空白列3-->
            <template v-if="table.type === 'other_1' || table.type === 'other_2' || table.type === 'other_3'">
              <template v-if="table.value_data">
                <template v-if="+table.value_data.value_type === 1"><!--空白列项--></template>
                <template v-else-if="+table.value_data.value_type === 2">
                  <!--固定列值-->
                  {{ table.value_data && table.value_data.default_value }}
                </template>
                <template v-else>
                  <!--关联其他基础数据值-->
                  {{ table.value_data && goods[table.value_data.value_type] }}
                </template>
              </template>
            </template>
            <template v-else>{{ goods[table.type] }}</template>
          </td>
        </tr>
      </template>
        </template>
      </template>
    </template>
    </tbody>
  </table>
  <!--endregion-->
</script>

<!-- JS -->
<script>
  AppUtil.COMPONENTS.PRINT_TABLE_MINI = {
    template: '#print_table_mini',
    components: {},
    props: {
      tplOrder: Object,
      depot: Object,
      order: Object,
      pIndex: [String, Number],
    },
    data: function () {
      return {}
    },
    computed: {
      // 是否是分页打印
      isPrintPage: function () {
        return this.tplOrder.tpl.tpl_config.pre_page_row !== '';
      },
      // 获取固定排序的表头数据
      getCheckedItemList: function () {
        var self = this;
        self.tplOrder.tpl.tpl_content[0].checkedItem.forEach(function (value) {
          if (value.type === 'goods_name') {
            self.$set(value, 'sort', 1)
          } else if (value.type === 'num') {
            self.$set(value, 'sort', 2)
          } else if (value.type === 'goods_price') {
            self.$set(value, 'sort', 3)
          } else if (value.type === 'total_price') {
            self.$set(value, 'sort', 4)
          } else {
            self.$set(value, 'sort', 5)
          }
        })
        var list = JSON.stringify(self.tplOrder.tpl.tpl_content[0].checkedItem);
        list = JSON.parse(list);
        list.sort(publicWap.compare('sort'));//排序
        return list;
      },
    },
    mounted: function () {
    },
    methods: {
      isShowGoods: function (pIndex, gIndex) {
        var self = this
        if (!self.isPrintPage) return true;
        // 分页打印
        var arr = []
        for (var i = 0; i < self.tplOrder.tpl.tpl_config.pre_page_row; i++) {
          arr.push(pIndex * self.tplOrder.tpl.tpl_config.pre_page_row + i)
        }
        return arr.indexOf(gIndex) > -1
      },
      tableThTd: function (table, index, goods) {
        var self = this;
        var defaultShow = true;
        var maxIndexLen = 3;
        var th_name = table.diy_name !== '' ? table.diy_name : table.default_name;
        var td_name = typeof goods !== 'undefined' ? goods[table.type] : '';
        if (+self.checkedObj('num').is_checked === 1 && +self.checkedObj('goods_price').is_checked === 1) {
          maxIndexLen = 4;
          if (table.type === 'goods_price') {
            defaultShow = false;
          } else if (table.type === 'num') {
            var numName = self.checkedObj('num').diy_name !== '' ? self.checkedObj('num').diy_name : self.checkedObj('num').default_name
            var goodsPriceName = self.checkedObj('goods_price').diy_name !== '' ? self.checkedObj('goods_price').diy_name : self.checkedObj('goods_price').default_name
            th_name = goodsPriceName + '*' + numName;
            if (typeof goods !== 'undefined') {
              td_name = goods.goods_price + '*' + goods.num;
            }
          }
        }
        var isShow = index < maxIndexLen && defaultShow
        return {isShow: isShow, th_name: th_name, td_name: td_name};
      },
      //表格td宽度
      tableThTdStyle: function (index) {
        var styleObj = {};
        switch (+index) {
          case 0:
            styleObj = {width: '45%', textAlign: 'left'}
            break
          case 1:
            break
          case 2:
            break
          default:
            break
        }
        return styleObj;
      },
      //是否显示【某个项】,key
      checkedObj: function (type) {
        var obj = {is_checked: 0, diy_name: ''}
        this.getCheckedItemList.forEach(function (value) {
          if (value.type === type) {
            obj = value
          }
        })
        return obj;
      },
    }
  }
</script>