<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>diy打印预览</title>
</head>
<link rel="stylesheet" href="__PUBLIC__/common/js/plug-in/DragResize/DragResize.css?v={$V}">
<body>
<div id="app" v-cloak="">
  <print-diy v-if="loadCompleted" :tpl-order="tplOrder" @submit-print="submitPrint" :style="'width:'+tplOrder.tpl.tpl_config.page_width"></print-diy>
</div>

<!--startprint-->
<style>
  body {
    overflow-y: auto;
    padding: 0;
    margin: 0;
  }
  .drsElement {
    position: absolute;
    background-color: transparent;
  }
  .editor-order-table {
    width: 100%;
    background: #FFFFff;
    border: 1px solid #000!important;
    border-collapse: collapse;
  }
  .editor-order-table td {
    border: 1px solid #000!important;
    min-width: 24px;
  }
  .dragresize-direct .print-table__undefined table,
  .dragresize-direct .print-table__undefined td,
  .dragresize-direct .print-table__0 table,
  .dragresize-direct .print-table__0 td {
    border: none!important;
  }
  .print-table__2 table,
  .print-table__2 td {
    border: 2px solid #000!important;
  }
  .print-table__3 table,
  .print-table__3 td {
    border: 3px solid #000!important;
  }
  .print-table__4 table,
  .print-table__4 td {
    border: 4px solid #000!important;
  }
  .print-table__5 table,
  .print-table__5 td {
    border: 4px solid #000!important;
  }
  .drsElement.drs__order-table {
    z-index: 1!important;
  }

  .drsElement .dragresize-content {
    overflow: hidden;
    max-height: 100%;
  }
  .drsElement .dragresize-content .custom-img {
    width: 100%;
    height: 100%;
    vertical-align: middle;
    background-size: 100% 100%;
    background-repeat: no-repeat;
  }
  /*region 热敏打印*/
  .dragresize-direct .editor-order-table td {
    text-align: center;
  }
  #print-content-html .dragresize-box {
    position: relative;
    height: calc(100% - 76px);
    overflow-y: hidden;
  }
  .table-bottom .flex-between {
    line-height: 20px;
    font-size: 12px;
  }
  .flex-between {
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: space-between;
  }
  .editor-order-table td {
    word-break: break-all;
  }
  .position-r {
    position: relative;
  }
  .table-box__num1,
  .table-box__num2 {
    display: flex;
    display: -webkit-flex;
    justify-content: space-between;
  }
  .table-box__num2 table {
    width: calc(50% - 5px);
  }
</style>
<div id="print-content-html"></div>
<!--endprint-->
</body>
<script type="text/javascript" src="__JQUERY__"></script>
<script type="text/javascript" src="__VUE_NEWEST__"></script>
<script src="__APP_UTIL__"></script>
<include file="PrintTpl/print/pages/print_diy" />
<script>
  var vm = new Vue({
    el: '#app',
    components: {
      'print-diy': AppUtil.COMPONENTS.PRINT_DIY,
    },
    data: function () {
      return {
        loadCompleted: false,
        query: {
          id: '{$req["id"]}',
          order_id: '{$req["order_id"]}', // 订单id
          depot_id: '{$req["depot_id"]}', // 仓库id
          show_bottom: '{$req["show_bottom"]}',// 是否显示底部统计信息
        },
        tplOrder: {
          orderList: [
            {
              order_id: 1,
              depotList: [
                {
                  depot_id: 0, // 如果没有分仓，默认id=0
                  goodsList: [
                    {id: 1, goods_name: '商品名称', goods_spec: '规格22',num: 1,goods_price: 2},
                  ] // 订单商品数据
                },
              ], // 仓库列表
            },
          ],
          tpl: {
            show_bottom: '{$req["show_bottom"]}',// 是否显示底部统计信息
            tpl_content: [{}], //"string,模版列表(可拖动的元素列数据)，包含变量词，表格等"
            tpl_config: {}
          },
        },
      }
    },
    computed: {
    },
    mounted: function () {
      this.initLoad();
    },
    methods: {
      initLoad: function () {
        var self = this;
        self.getPrintTplData().then(function (result) {
          self.tplOrder.tpl = result.data;
          self.getOrderData();
        })
      },
      // 获取diy模板数据
      getPrintTplData: function () {
        var self = this;
        return AppUtil.ajaxRequest({
          url: '/Public/json/admin/PrintTpl/printTplInfo/getPrintTplData_'+self.query.id+'.json',
          type: 'get',
          data: {
            id: self.query.id,
          },
        })
      },
      //获取订单数据
      getOrderData: function () {
        var self = this
        AppUtil.ajaxRequest({
          type: 'get',
          url: '/Public/json/admin/PrintTpl/print/getOrder_'+self.query.order_id+'.json',
          data: self.query,
        }).then(function (result) {
          self.tplOrder.orderList = result.data.orderList;
          self.loadCompleted = true;
        }).catch(function () {

        }).finally(function () {
          window.parent.layer.closeAll('loading');
        })
      },

      submitPrint: function () {
        var self = this
        this.$nextTick(function () {
          bdhtml = window.document.body.innerHTML;
          sprnstr = "<!--startprint-->";
          eprnstr = "<!--endprint-->";
          prnhtml = bdhtml.substr(bdhtml.indexOf(sprnstr) + 17);
          prnhtml = prnhtml.substring(0, prnhtml.indexOf(eprnstr));
          window.document.body.innerHTML = prnhtml;
          window.document.body.style.backgroundColor = '#fff';
          if (+'{$req["is_export"]}' === 1) {
            // 导出export
            self.exportDiy(prnhtml);
          } else {
            window.print();
          }
        })
      },
      exportDiy: function (prnhtml) {
        var self = this
        window.parent.layer.load()
        // 将大文本内容保存到缓存接口
        AppUtil.ajaxRequest({
          url: AppUtil.getTPUrl('Common', 'saveContent'),
          data: {content: prnhtml},
        }).then(function (result) {
          // html导出excel接口
          var url = AppUtil.getTPUrl('Common', 'html2Excel') + '&content_key=' + result.data.key;
          window.open(url)
        }).finally(function () {
          window.parent.layer.closeAll('loading');
        })
      }
    },
  })
</script>
</html>
