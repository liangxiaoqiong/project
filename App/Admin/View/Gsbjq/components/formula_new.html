<!--
  @author   liangxiaoqiong
  @version  1.0
  @date 2024/6/18
  -->
<!-- template -->
<style>
  .formula-box {
    border: 1px dashed #bbbbbb;
  }
  .formula-box .formula-content  {
    min-height: 150px;
    vertical-align: middle;
  }
  .formula-box .formula-title {
    font-size: 14px;
    border-bottom: 1px dashed #bbbbbb;
    padding: 10px 14px;
    color: #999999;
    min-height: 50px;
  }
  .formula-box .formula-title b {
    color: #101010;
  }
  .formula-box.formula-rich .formula-content,
  .formula-box.formula-operator .formula-content {
    height: 200px;
    overflow-y: auto;
  }
  .formula-box.formula-rich {
    width: calc(100% - 255px);
  }
  .formula-box.formula-rich .formula-content {
    background-color: #f8f8f8;
    padding: 10px 15px;
  }
  .formula-rich .rich-content {
    height: 100%;
  }
  .rich-content .content-item {
    position: relative;
    cursor: text;
    user-select: none;
    display: flex;
    align-items: center;
    float: left;
    line-height: 22px;
    font-size: 13px;
  }
  .formula-box.formula-rich .attr {
    height: 22px;
    line-height: 22px;
    background-color: rgba(26,143,252,.16);
    border-radius: 2px;
    padding: 0 10px;
    color: #101010;
    display: inline-block;
    margin: 1px;
    font-size: 12px;
  }
  .formula-box.formula-rich .operator {
    color: #DF2727;
  }
  .formula-box.formula-operator {
    width: 240px;
  }
  .formula-box.formula-fun {
    width: calc(100% - 385px);
  }
  .formula-box.formula-fun .formula-content {
    height: calc(100% - 50px);
    align-items: flex-start;
  }
  .formula-box.formula-fun .formula-content .param-list {
    overflow-y: auto;
    height: 100%;
  }
  .formula-box.formula-fun .formula-content .param-list .alias-name {
    color: #999999;
    height: 100%;
    display: flex;
    display: -webkit-flex;
    align-items: center;
    justify-content: flex-end;
    min-height: 50px;
    flex: 1;
  }
  .formula-box.formula-fun .formula-content .param-list .alias-name:hover {
    text-decoration: underline;
  }
  .formula-operator .operator-list a {
    min-width: 38px;
    padding: 0 5px;
    height: 38px;
    line-height: 36px;
    display: inline-block;
    border-radius: 4px;
    background-color: #f8f8f8;
    border: 1px solid #bbbbbb;
    text-align: center;
    font-size: 20px;
    color: #101010;
    margin: 10px;
  }
  .formula-operator .operator-list a:hover {
    background-color: rgb(26 143 252 / 10%);
    color: #1A8FFC;
  }
  .formula-box.formula-attr,
  .formula-box.formula-fun {
    height: 460px;
  }
  .formula-box.formula-attr {
    width: 370px;
  }
  .formula-box.formula-attr .formula-content {
    height: calc(100% - 100px);
    overflow-y: auto;
  }
  .formula-box .param-list {
    padding: 0 10px;
  }
  .formula-box .param-list .param-list-li {
    border-bottom: 1px dashed #bbbbbb;
    min-height: 50px;
  }
  .formula-box .param-list .type-tag {
    background-color: rgba(223,132,39,0.1);
    color: #DF8427;
    width: 44px;
    height: 22px;
    border-radius: 2px;
  }
  .formula-box .param-list .param-name:hover {
    color: #1A8FFC;
    text-decoration: underline;
  }
  .explain-box {
    background-color: #f8f8f8;
    height: 100%;
    flex: 1;
  }
  .explain-box .explain-title {
    height: 40px;
    padding: 0 15px;
    font-size: 14px;
    color: #101010;
  }
  .explain-box .explain-content {
    padding: 0 15px;
    height: calc(100% - 40px);
    overflow-y: auto;
  }
  .explain-box .explain-content .example-box {
    background-color: #ffffff;
    padding: 5px 10px;
    border-radius: 4px;
    margin-top: 5px;
    color: #101010;
  }
  .explain-box .explain-content .example-box .example-li {
    margin-bottom: 5px;
  }
  .explain-box .explain-content .example-box .example-li:last-child {
    margin-bottom: 0;
  }
  /*region 光标样式*/
  .cursor {
    height: 16px;
    width: 1px;
    background: #333;
    animation:defaultCursor 1s steps(2) infinite;
    position: absolute;
    right: 0;
  }
  @keyframes defaultCursor {
    0% {
      opacity: 1;
    }
    100% {
      opacity: 0;
    }
  }
  /*endregion*/
</style>
<script type="x-template" id="formula_new">
  <!--region 模版-->
  <div>
    <div class="flex-between" style="margin-bottom: 20px;">
      <!--region 公式编辑器-->
      <div class="formula-box formula-rich">
        <div class="formula-title flex-between">
          <b>公式=</b>
          <a class="febtn-white" @click.stop="clearAll">清空内容</a>
        </div>
        <div id="formula-view" class="formula-content">
          <div
            class="rich-content"
            ref="formulaView"
            @click.stop="recordPosition()">
            <div class="content-item" v-for="(item,index) in formulaList" :key="index" @click.stop="recordPosition(index)" >
              <div :class="item.type">
                &zwj;{{ item.text }}
              </div>
              <!--光标-->
              <div class="cursor" v-if="item.cursor"></div>
            </div>
          </div>
        </div>
      </div>
      <!--endregion-->

      <!--region 运算符-->
      <div class="formula-box formula-operator">
        <div class="formula-title">运算符</div>
        <div class="formula-content operator-list">
          <a v-for="(operator, index) in operatorList" :title="operator.tip"
             @click.stop="addItem({text: operator.name, type: 'operator', item: operator})">
            {{ operator.name }}
          </a>
        </div>
      </div>
      <!--endregion-->
    </div>
    <div class="flex-between">
      <!--region 属性列表-->
      <div class="formula-box formula-attr">
        <div class="formula-title">
          <div>属性列表</div>
          <div class="input-unit mt-10">
            <input type="text" v-model="query.keyword_attr" placeholder="请输入搜索关键词">
            <em class="unit-bg" @click.stop="searchAttr"><i class="feimg-search-grey"></i></em>
          </div>
        </div>
        <div class="formula-content param-list">
          <div class="param-list-li flex-between" v-for="(attr, index) in attrList">
            <div>
              <span class="color-tip">{{ index + 1 }}</span>
              <a class="param-name ml-10"
                    @click="addItem({text: attr.name, type: 'attr', item: attr})">{{ attr.name }}</a>
            </div>
            <div>
              <span class="type-tag flex-row">
                <template v-if="+attr.type === 1">数字</template>
                <template v-else-if="+attr.type === 2">文本</template>
             </span>
            </div>
          </div>
        </div>
      </div>
      <!--endregion-->

      <!--region 函数列表-->
      <div class="formula-box formula-fun">
        <div class="formula-title flex-between">
          <div>函数列表</div>
          <div class="input-unit">
            <input type="text" v-model="query.keyword_fun" placeholder="请输入搜索关键词">
            <em class="unit-bg" @click.stop="searchFun"><i class="feimg-search-grey"></i></em>
          </div>
        </div>
        <div class="formula-content flex-between">
          <div class="param-list" style="width: 370px;">
            <div class="param-list-li flex-between" v-for="(fun, index) in funList">
              <div>
                <span class="color-tip">{{ index + 1 }}</span>
                <a class="param-name ml-10" @click.stop="addItem({type: 'fun', item: fun})">
                  {{ fun.name }}(<template v-for="(item, i) in fun.param_list">{{ item.val }}<template v-if="i < fun.param_list.length - 1">,</template></template>)
                </a>
              </div>
              <a class="alias-name" @click.stop="funKey = index">{{ fun.alias_name }}</a>
            </div>
          </div>
          <div class="explain-box">
            <div class="explain-title flex-left">函数介绍</div>
            <div class="explain-content">
              <div class="explain-name" style="margin-bottom: 5px;">
                <span class="color-red">{{ funList[funKey].name }}</span>(<template v-for="(item, i) in funList[funKey].param_list"><b style="color: green;">{{ item.type_text }}</b><template v-if="i < funList[funKey].param_list.length - 1">,</template></template>)
              </div>
              <div class="explain-desc color-tip">{{ funList[funKey].desc }}</div>
              <div class="explain-example mt-10">
                <div class="color-tip">示例</div>
                <div class="example-box">
                  <div class="example-li" v-for="(example, j) in funList[funKey].example_list">
                    <span class="color-red">{{ funList[funKey].name }}</span>(<template v-for="(val, i) in example.param">{{ val }}<template v-if="i < example.param.length - 1">, </template></template>)
                    <span class="color-red">==</span>
                    <span>{{ example.result }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!--endregion-->
    </div>
  </div>
  <!--endregion-->
</script>

<!-- JS -->
<script>
  AppUtil.COMPONENTS.FORMULA_NEW = {
    template: '#formula_new',
    components: {},
    props:{
    },
    data: function () {
      return {
        query: {
          keyword_attr: '', // 属性列表的关键字检索
          keyword_fun: '', // 函数列表的关键字检索
        },
        attrList: [
          {
            id: 1,
            name: '长',
            type: '1', // 属性类型：1: '数字', 2: '文本'
          },
          {id: 2, name: '宽', type: '1',},
          {id: 3, name: '高', type: '1',},
          {id: 3, name: '体积', type: '1',},
        ], // 属性列表数据
        funList: [
          {
            name: 'ROUND', // 函数名称
            alias_name: '四舍五入', // 别名
            param_list: [
              {val: 'x', type_text: '数值'},
              {val: 'n', type_text: '小数位精度数'},
            ], // 入参列表
            desc: '按指定的小数位n精确度对数值x进行四舍五入。小数位精确度n：默认为0，即如果不传只保留整数。',
            example_list: [
              {param: [3.44, 1], result: '3.4'},
              {param: [3.5], result: '4'},
            ],
          },
          {
            name: 'Floor',
            alias_name: '向下取整数',
            param_list: [
              {val: 'x', type_text: '数值'},
            ],
            desc: '对数值x进行向下取整数',
            example_list: [
              {param: [1.6], result: '1'},
              {param: [1.4], result: '1'},
            ],
          },
          {
            name: 'Ceil',
            alias_name: '向上取整数',
            param_list: [
              {val: 'x', type_text: '数值'},
            ],
            desc: '对数值x进行向上取整数',
            example_list: [
              {param: [1.6], result: '2'},
              {param: [1.4], result: '2'},
            ],
          },
        ], // 函数列表数据
        funKey: 0, // 函数介绍key
        formulaList:[
          /*{
            text: "5", //  文本内容：键盘输入的数字、属性名称、运算符符号等
            type: "num", // 文本类型：'num'-纯键盘输入的数字，'attr'-属性，'fun'-函数，'operator'-运算符，'placeholder'-占位符
            cursor: false, // 光标是否在该位置之后
          }*/
        ], // 公式编辑器内容数据
        //运算符列表数据
        operatorList:[
          {
            name: '+',
            id: '+',
            tip: '加号',
            keyCode: 107, // 对应键盘的key
          },
          {name: '-', id: '-', tip: '减号', keyCode: 109},
          {name: '*', id: '*', tip: '乘号', keyCode: 106},
          {name: '/', id: '/', tip: '除号', keyCode: 111},
          {name: '(', id: '(', tip: '左括号', keyCode: 57},
          {name: ')', id: ')', tip: '右括号', keyCode: 48},
          {name: '()', id: '()', tip: '括号'},
        ]
      }
    },
    watch:{
      // 监听编辑器内容，当编辑器内容数据变化，触发事件
      formulaList (val) {

      }
    },
    created() {
      this.init();
    },
    destroyed () {
      this.removeEvent();
    },
    methods: {
      init: function () {
        // 监听鼠标事件
        this.addEvent();
        // 获取数据
        this.getData();
      },
      // 添加监听事件
      addEvent: function () {
        var self = this;
        self.$nextTick(function () {
          document.addEventListener("keydown", self.keydown, false);
          document.addEventListener('click', function(event) {
            // 检查被点击的元素是否是我们想要排除的元素
            if (event.target.id !== 'formula-view' && !event.target.matches('#formula-view *')) {
              // 如果不是，就执行你想要的操作
              self.formulaBlur();
            }
          });
        });
      },
      // 移除监听事件
      removeEvent: function () {
        var self = this;
        self.$nextTick(function () {
          document.removeEventListener("keydown", self.keydown, false);
          document.removeEventListener('click', self.formulaBlur);
        })
      },
      //失去焦点
      formulaBlur: function () {
        this.formulaList = this.formulaList?.map(item=>{
          item.cursor = false;
          return item
        })
      },
      // 获取数据：公式内容，函数、属性、运算符 数据
      getData: function(){
      },
      // 点选时记录光标位置
      recordPosition: function (index) {
        var self = this;
        if(this.formulaList && this.formulaList.length > 0){
          this.formulaList = this.formulaList.map((item,itemIndex)=>{
            item.cursor = false;
            if(index > -1 && index == itemIndex){
              item.cursor = true;
            }else if((index!==0 && !index) && itemIndex == (self.formulaList.length -1)){
              item.cursor = true;
            }
            return item
          });
        }else {
          this.formulaList = [
            {
              type: 'placeholder',
              text: '',
              cursor: true,
            }
          ]
          this.$forceUpdate();
        }
      },
      /**
       * @returns {addItem<*, void, *>}
       * 添加字段
       * config: {
       *  text 插入的文本内容
       *  type 文本类型：'num'-纯键盘输入的数字，'attr'-属性，'fun'-函数，'operator'-运算符
       *  item 插入的数据
       * }
       */
      addItem: function (config) {
        var self = this;
        var addList = [{text: config.text, type: config.type, cursor: true}];
        switch (config.type) {
          case 'num': // 纯键盘输入的数字
          case 'attr': // 属性 类型
            break
          case 'fun': // 函数 类型
            addList = [
              {text: config.item.name, type: config.type, cursor: false},
              {text: '(', type: config.type, cursor: true},
            ];
            if (config.item.param_list.length > 1) {
              for (var i = 0; i <config.item.param_list.length; i++) {
                if (i > 0 && i < config.item.param_list.length) {
                  addList.push({text: ',', type: config.type, cursor: false});
                }
              }
            }
            addList.push({text: ')', type: config.type, cursor: false});
            break
          case 'operator': // 运算符 类型
            if (config.item.id == '()') {
              addList = [{text: '(', type: config.type, cursor: true}, {text: ')', type: config.type, cursor: false}];
            }
            break
          default:
            break
        }
        var listNew = JSON.parse(JSON.stringify(self.formulaList));
        var cursorKey = listNew.length > 0 ? listNew.length - 1 : 0;
        if (listNew.length > 0) {
          listNew.forEach(function (value, index) {
            if (value.cursor) {
              cursorKey = index;
            }
            value.cursor = false;
          })
        }
        addList.forEach(function (arr, i) {
          listNew.splice(cursorKey + 1 + i, 0, arr);
        })
        var cursorKeyNew;
        listNew?.find((item,itemIndex)=>{
          if(item.cursor){
            cursorKeyNew = itemIndex
          }
        });
        self.formulaList = JSON.parse(JSON.stringify(listNew));
        self.$forceUpdate();
        setTimeout(function () {
          // 延时异步操作，等blur事件formulaBlur结束后执行
          self.recordPosition(cursorKeyNew);
        }, 50)
      },
      //清除全部
      clearAll: function () {
        var self = this;
        this.formulaList = [];
        setTimeout(function () {
          self.recordPosition();
        },100);
      },
      //删除
      deleteItem: function (type){
        let arr = JSON.parse(JSON.stringify(this.formulaList)),index = null;
        const length = arr?.length;
        for (let i = 0; i < length; i++) {
          if(arr[i].cursor && arr[i].key){
            index = i;
            if(type == 'del'){
              index = i + 1;
            }
            if(index > -1){
              this.formulaList.splice(index,1);
              if(type == 'del') {
              }else {
                this.recordPosition(index - 1);
              }
            }
            break;
          }
        }
      },
      // 键盘输入
      keydown: function (e) {
        //禁止输入
        // 检测光标是否存在
        let index,cursorData = this.formulaList?.find((item,itemIndex)=>{
          if(item.cursor){
            index = itemIndex
          }
          return item.cursor
        });
        if(!cursorData){
          return false;
        }
        //左右移动键控制光标位置
        if (e && [37,39].includes(e.keyCode)){
          if(e.keyCode == 37){index = index - 1;}else {index = index + 1;}
          if(index > -1 && index < this.formulaList.length){
            this.recordPosition(index);
          }
        }else if (e && e.keyCode == 8){
          //Backspace 键 删除前面的值
          this.deleteItem();
        }else if (e && [107,109,106,111].includes(e.keyCode)){
          //运算符列表
          var operatorItem = this.operatorList?.find((item)=>{
            if(+item.keyCode === +e.keyCode){
              return item
            }
          });
          this.addItem({text: operatorItem.name, type: 'operator', item: operatorItem})
        }else if (e && e.shiftKey && [48,57].includes(e.keyCode) ){
          //括号
          var operatorItem = this.operatorList?.find((item)=>{
            if(+item.keyCode === +e.keyCode){
              return item
            }
          });
          this.addItem({text: operatorItem.name, type: 'operator', item: operatorItem})
        }else if (e && e.keyCode == 46){
          //delete键删除光标后面的值
          this.deleteItem('del');
        }else {
          document.returnValue = false;
          var tt=/^([1-9]{1}[0-9]{0,7})$/;//能输入正数
          if(tt.test(e.key)){
            //输入为数字 插入数字
            this.addItem({text: e.key, type: 'num'})
          }
        }
      },

      // 属性列表模糊检索
      searchAttr: function () {

      },
      // 函数列表模糊检索
      searchFun: function () {

      },
    }
  }
</script>
